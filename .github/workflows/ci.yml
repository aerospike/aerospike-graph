name: Basic Example and TLS Tests

on:
  pull_request:
    branches:
      - main
    paths-ignore:
      - 'python/load_balancer/**'
      - 'nodejs/load-balancer/**'
      - 'golang/load-balancer/**'

concurrency:
  group: ci-${{ github.ref }}
  cancel-in-progress: true

jobs:
  test:
    runs-on: ubuntu-latest

    steps:
      - name: Harden the runner (Audit all outbound calls)
        uses: step-security/harden-runner@df199fb7be9f65074067a9eb93f12bb4c5547cf2 # v2.13.3
        with:
          egress-policy: audit

      - name: Checkout repository
        uses: actions/checkout@f43a0e5ff2bd294095638e18286ca9a3d1956744 # v3.6.0

      - name: Set up Aerospike Server and Graph
        run: |
          sudo apt-get update
          docker compose up -d

      - name: Setup Node.js 22.x
        uses: actions/setup-node@3235b876344d2a9aa001b8d1453c930bba69e610 # v3.9.1
        with:
          node-version: '22'

      - name: Setup Python 3.9
        uses: actions/setup-python@7f4fc3e22c37d6ff65e88745f38bd3157c663f7c # v4.9.1
        with:
          python-version: '3.9'

      - name: Upgrading Pip
        working-directory: python
        run: |
          python -m pip install --upgrade pip

      - name: Wait for AGS
        run: docker compose up -d --wait

      - name: Run pytest against python transactions ui example
        working-directory: python/transactions
        run: |
          pip install -r requirements.txt
          pytest tests/ -v --maxfail=1

      - name: Run pytest against python food_delivery_app
        working-directory: python/food_delivery_app
        run: |
          pip install -r requirements.txt
          pytest tests/ -v --maxfail=1

      - name: Install dependencies node-js
        working-directory: nodejs/basic
        run: npm ci

      - name: Run Mocha tests
        working-directory: nodejs/basic
        run: npm test

      - name: Run Playwright E2E tests
        working-directory: nodejs/basic
        run: |
          npx playwright install --with-deps
          npm run test:e2e

      - name: Set Up Java
        uses: actions/setup-java@17f84c3641ba7b8f6deff6309fc4c864478f5d62 # v3.14.1
        with:
          java-version: '11'
          distribution: 'temurin'

      - name: Test Java Example
        working-directory: java/basic
        run: |
          mvn test

      - name: Close Docker Containers
        run: |
          docker compose down

      - name: Install TLS test dependencies
        working-directory: python/tls
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Install OpenSSL (required for certificate generation)
        run: |
          sudo apt-get update
          sudo apt-get install -y openssl

      - name: Run AGS-to-AerospikeDB Certificate Tests
        working-directory: python/tls/tests
        run: |
          pytest test_AGS_DB_certificates.py -v

      - name: Run AGS-to-AerospikeDB Connection Tests
        working-directory: python/tls/tests
        run: |
          pytest test_AGS_DB_connection.py -v --maxfail=1
        timeout-minutes: 2

      - name: Run GremlinClient-to-AGS Certificate Tests
        working-directory: python/tls/tests
        run: |
          pytest test_Gremlin_AGS_certificates.py -v

      - name: Run GremlinClient-to-AGS Connection Tests
        working-directory: python/tls/tests
        run: |
          pytest test_Gremlin_AGS_connection.py -v --maxfail=1
        timeout-minutes: 2